-- =========================
-- DROP TABLES (依存関係順に)
-- =========================
DROP TABLE IF EXISTS ALLOCATION_STOCK;
DROP TABLE IF EXISTS ALLOCATION_HEAD;
DROP TABLE IF EXISTS STOCK_MOVEMENT;
DROP TABLE IF EXISTS SLIP_DETAIL;
DROP TABLE IF EXISTS SLIP_HEAD;
DROP TABLE IF EXISTS INVENTORY_STOCK;
DROP TABLE IF EXISTS PURCHASE_DETAIL;
DROP TABLE IF EXISTS PURCHASE_HEAD;
DROP TABLE IF EXISTS LOT_COST;
DROP TABLE IF EXISTS LOT_MASTER;
DROP TABLE IF EXISTS SALES_DETAIL;
DROP TABLE IF EXISTS SALES_HEAD;
DROP TABLE IF EXISTS LOCATION_MASTER;
DROP TABLE IF EXISTS WAREHOUSE_MASTER;
DROP TABLE IF EXISTS PARTNER_MASTER;
DROP TABLE IF EXISTS PRODUCT_MASTER;

-- =========================
-- 1. PRODUCT_MASTER
-- =========================
CREATE TABLE PRODUCT_MASTER (
	PRODUCT_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PRODUCT_NAME VARCHAR(255) NOT NULL,
    UNIT_OF_MEASURE VARCHAR(10) NOT NULL,
    SAFETY_STOCK INT NOT NULL,
    MIN_ORDER_QTY INT NOT NULL,
    IS_LOT_MANAGED INT NOT NULL,
    IS_ACTIVE INT NOT NULL,
    IS_VISIBLE INT NOT NULL DEFAULT 1
);

-- =========================
-- 2. PARTNER_MASTER
-- =========================
CREATE TABLE PARTNER_MASTER (
    PARTNER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PARTNER_TYPE CHAR(1) NOT NULL,
    PARTNER_NAME VARCHAR(100) NOT NULL,
    IS_VISIBLE INT NOT NULL DEFAULT 1
);

-- =========================
-- 3. WAREHOUSE_MASTER
-- =========================
CREATE TABLE WAREHOUSE_MASTER (
    WAREHOUSE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    WAREHOUSE_NAME VARCHAR(50) NOT NULL,
    IS_VISIBLE INT NOT NULL DEFAULT 1
);

-- =========================
-- 4. LOCATION_MASTER
-- =========================
CREATE TABLE LOCATION_MASTER (
    WAREHOUSE_ID NUMBER NOT NULL,
    ZONE_ID CHAR(3) NOT NULL,
    RACK_ID CHAR(3) NOT NULL,
    SHELF_ID CHAR(5) NOT NULL,
    LOCATION_CODE CHAR(16) UNIQUE,
    MAX_CAPACITY INT,
    IS_VISIBLE INT NOT NULL DEFAULT 1,
    PRIMARY KEY (WAREHOUSE_ID, ZONE_ID, RACK_ID, SHELF_ID),
    FOREIGN KEY (WAREHOUSE_ID) REFERENCES WAREHOUSE_MASTER(WAREHOUSE_ID)
);

-- =========================
-- 5. PURCHASE_HEAD
-- =========================
CREATE TABLE PURCHASE_HEAD (
    ORDER_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SUPPLIER_ID NUMBER,
    ORDER_DATE DATE NOT NULL,
    TOTAL_AMOUNT DECIMAL(14,2),
    FOREIGN KEY (SUPPLIER_ID) REFERENCES PARTNER_MASTER(PARTNER_ID)
);

-- =========================
-- 6. PURCHASE_DETAIL
-- =========================
CREATE TABLE PURCHASE_DETAIL (
    ORDER_ID BIGINT NOT NULL,
    LINE_NO INT NOT NULL,
    PRODUCT_ID BIGINT,
    UNIT_PRICE DECIMAL(10,2) NOT NULL,
    ORDER_QUANTITY INT NOT NULL,
    PRIMARY KEY (ORDER_ID, LINE_NO),
    FOREIGN KEY (ORDER_ID) REFERENCES PURCHASE_HEAD(ORDER_ID),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID)
);

-- =========================
-- 7. LOT_MASTER
-- =========================
CREATE TABLE LOT_MASTER (
    PRODUCT_ID BIGINT NOT NULL,
    LOT_NO CHAR(20) NOT NULL,
    CREATION_DATE TIMESTAMP NOT NULL,
    SUPPLIER_ID NUMBER,
    EXPIRATION_DATE DATE,
    QC_STATUS_ID CHAR(1) NOT NULL,
	IS_VISIBLE INT NOT NULL DEFAULT 1,
    PRIMARY KEY (PRODUCT_ID, LOT_NO),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID),
    FOREIGN KEY (SUPPLIER_ID) REFERENCES PARTNER_MASTER(PARTNER_ID)
);

-- =========================
-- 8. LOT_COST
-- =========================
CREATE TABLE LOT_COST (
    PRODUCT_ID BIGINT NOT NULL,
    LOT_NO CHAR(20) NOT NULL,
    CONVERTED_COST_JPY DECIMAL(14,2) NOT NULL,
    PRIMARY KEY (PRODUCT_ID, LOT_NO),
    FOREIGN KEY (PRODUCT_ID, LOT_NO) REFERENCES LOT_MASTER(PRODUCT_ID, LOT_NO)  
);

-- =========================
-- 9. INVENTORY_STOCK
-- =========================
CREATE TABLE INVENTORY_STOCK (
    STOCK_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PRODUCT_ID BIGINT,
    LOCATION_CODE CHAR(16),
    LOT_NO CHAR(20),
    STOCK INT NOT NULL,
    UNIQUE (PRODUCT_ID, LOCATION_CODE, LOT_NO),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID)
);

-- =========================
-- 10. SLIP_HEAD
-- =========================
CREATE TABLE SLIP_HEAD (
    SLIP_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SLIP_STATE_ID CHAR(1) NOT NULL
);

-- =========================
-- 11. SLIP_DETAIL
-- =========================
CREATE TABLE SLIP_DETAIL (
    SLIP_ID BIGINT NOT NULL,
    LINE_NO INT NOT NULL,
    PRODUCT_ID BIGINT,
    QUANTITY INT NOT NULL,
    PRIMARY KEY (SLIP_ID, LINE_NO),
    FOREIGN KEY (SLIP_ID) REFERENCES SLIP_HEAD(SLIP_ID),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID)
);

-- =========================
-- 12. STOCK_MOVEMENT
-- =========================
CREATE TABLE STOCK_MOVEMENT (
    MOVEMENT_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SLIP_ID BIGINT,
    LINE_NO INT,
    MOVE_SEQ INT,
    PRODUCT_ID BIGINT,
    LOT_NO CHAR(20) NOT NULL,
    LOCATION_FROM CHAR(16),
    LOCATION_TO CHAR(16),
    STOCK_CHANGE INT NOT NULL,
    UNIQUE (SLIP_ID, LINE_NO, MOVE_SEQ),
    FOREIGN KEY (SLIP_ID) REFERENCES SLIP_HEAD(SLIP_ID),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID)
);

-- =========================
-- 13. SALES_HEAD
-- =========================
CREATE TABLE SALES_HEAD (
    SALES_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_ID NUMBER,
    SHIPPING_DATE DATE NOT NULL,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES PARTNER_MASTER(PARTNER_ID)
);

-- =========================
-- 14. SALES_DETAIL
-- =========================
CREATE TABLE SALES_DETAIL (
    SALES_ID BIGINT NOT NULL,
    LINE_NO INT NOT NULL,
    PRODUCT_ID BIGINT,
    UNIT_PRICE DECIMAL(10,2) NOT NULL,
    ORDER_QUANTITY INT NOT NULL,
    PRIMARY KEY (SALES_ID, LINE_NO),
    FOREIGN KEY (SALES_ID) REFERENCES SALES_HEAD(SALES_ID),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT_MASTER(PRODUCT_ID)
);

-- =========================
-- 15. ALLOCATION_HEAD
-- =========================
CREATE TABLE ALLOCATION_HEAD (
    ALLOCATE_HEAD_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SALES_ID BIGINT,
    STATUS CHAR(1) NOT NULL,
    FOREIGN KEY (SALES_ID) REFERENCES SALES_HEAD(SALES_ID)
);

-- =========================
-- 16. ALLOCATION_STOCK
-- =========================
CREATE TABLE ALLOCATION_STOCK (
    SLIP_ID BIGINT NOT NULL,
    LINE_NO INT NOT NULL,
    ALLOCATION_ID BIGINT NOT NULL,
    PRODUCT_ID BIGINT NOT NULL,
    LOT_NO CHAR(20) NOT NULL,
    ALLOCATED_QUANTITY INT NOT NULL,
    PRIMARY KEY (SLIP_ID, LINE_NO, ALLOCATION_ID),
    FOREIGN KEY (PRODUCT_ID, LOT_NO) REFERENCES LOT_MASTER(PRODUCT_ID,LOT_NO)
);